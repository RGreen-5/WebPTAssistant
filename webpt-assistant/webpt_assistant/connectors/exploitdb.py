import re
import subprocess


def _guess_keywords_from_nmap(nmap_stdout: str) -> set[str]:
    kws = set()
    for line in nmap_stdout.splitlines():
        if "/tcp" in line and "open" in line:
            kws.add(line.strip())
    return kws


def _searchsploit(query: str, timeout_s: int = 10) -> list[dict]:
    # Use JSON output to parse reliably
    cmd = ["searchsploit", "--json", query]
    p = subprocess.run(cmd, capture_output=True, text=True, timeout=timeout_s)
    if p.returncode != 0 or not p.stdout.strip():
        return []
    try:
        import json
        data = json.loads(p.stdout)
        out = []
        for row in data.get("RESULTS_EXPLOIT", []):
            out.append({
                "title": row.get("Title"),
                "path": row.get("Path"),
                "type": "exploit",
            })
        for row in data.get("RESULTS_SHELLCODE", []):
            out.append({
                "title": row.get("Title"),
                "path": row.get("Path"),
                "type": "shellcode",
            })
        return out[:10]
    except Exception:
        return []


def enrich_with_searchsploit(groups: list[dict], nmap_stdout: str) -> list[dict]:
    # Lightweight: use alert name + (if present) CWE as query
    for g in groups:
        q = g["alert"]
        cwe = g.get("cweid")
        if cwe and str(cwe).isdigit() and int(cwe) > 0:
            q2 = f"CWE-{cwe} {q}"
        else:
            q2 = q

        hits = _searchsploit(q2)
        if not hits:
            hits = _searchsploit(q)

        g["exploitdb"] = {"query": q2, "hits": hits}

    # Optional: add a global “service keyword” hit list
    svc = sorted(_guess_keywords_from_nmap(nmap_stdout))[:10]
    return groups
